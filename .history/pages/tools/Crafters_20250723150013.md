<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工匠收益计算器</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- General & Layout Styles --- */
        :root {
            --primary-color: #3498db;
            --background-color: #f4f7f9;
            --container-bg: #fff;
            --border-color: #d1d9e6;
            --text-color: #333;
            --text-light: #5a6a7e;
            --header-bg: #f2f5f8;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI',
                Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .tab-content {
            display: none;
            padding: 25px;
            animation: fadeIn 0.5s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        /* --- General UI Components --- */
        h2 {
            text-align: center;
            color: var(--text-color);
            margin-top: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th,
        td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            text-align: center;
            vertical-align: middle;
        }

        th {
            background-color: var(--header-bg);
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
        }

        input[type="number"],
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            text-align: center;
            vertical-align: middle;
        }

        .note p,
        .note ol li {
            font-size: 12px;
            color: gray;
        }

        /* === Artisan Calculator Styles === */
        #artisan-calculator-container th {
            cursor: pointer;
        }

        #artisan-calculator-container td {
            text-align: left;
            white-space: nowrap;
        }

        #artisan-calculator-container tbody tr.product-locked {
            opacity: 0.5;
            font-style: italic;
            background-color: #fafafa;
        }

        #artisan-calculator-container .level-control button {
            margin: 0 3px;
            padding: 2px 5px;
            cursor: pointer;
        }

        #artisan-calculator-container .level-value {
            display: inline-block;
            width: 25px;
            text-align: center;
        }

        #artisan-calculator-container .preview-text {
            color: #27ae60;
            font-size: 0.9em;
            margin-left: 5px;
        }

        #artisan-calculator-container .material-consumption {
            font-size: 0.85em;
            color: #555;
        }

        #artisan-calculator-container .controls-box,
        #artisan-calculator-container #kValueResults {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #eee;
            background-color: #fdfdfd;
            border-radius: 5px;
        }

        #artisan-calculator-container .controls-box label,
        #artisan-calculator-container .controls-box input,
        #artisan-calculator-container .controls-box button {
            margin-right: 10px;
        }

        #artisan-calculator-container #kValueResults h4 {
            margin-top: 0;
        }

        #artisan-calculator-container #profitChartContainer {
            width: 100%;
            max-width: 800px;
            margin: 30px auto;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div id="artisan-calculator-container" class="tab-content active">
            <h2>工匠收益计算器</h2>
            <div class="controls-box" id="controls">
                <label for="craftsmenInput">工匠数量 (m):</label>
                <input type="number" id="craftsmenInput" value="3" min="1">
                <label for="countersInput">柜台数量 (n >= m):</label>
                <input type="number" id="countersInput" value="5" min="1">
                <button id="calculateKValuesBtn">计算k值和最大收益</button>
            </div>
            <div id="kValueResults">
                <h4>时间分配和最大收益:</h4>
                <div id="maxProfitResult">-</div>
                <div id="kDistributionResult">-</div>
                <hr style="margin: 15px 0; border-style: dashed;">
                <h4>“偷懒”方案:</h4>
                <div id="lazySchemeProfitResult">-</div>
                <div id="improvementRateResult">-</div>
            </div>
            <div id="profitChartContainer"><canvas id="profitRateChart"></canvas></div>
            <div style="overflow-x: auto;">
                <table id="productTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="toggleAllLockCheckbox" title="切换全部解锁/未解锁"> 解锁</th>
                            <th>产品</th>
                            <th>当前生产时间</th>
                            <th>当前基础价格</th>
                            <th id="levelHeader">等级</th>
                            <th id="sortHeaderRate">每分钟收益率 <span>▼</span></th>
                            <th>每秒材料消耗</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="note">
                <p>注释：</p>
                <ol>
                    <li>鼠标悬浮在等级“+”按钮上查看升级详情。</li>
                    <li>调整等级后表格会实时变化，注意不要连续点击</li>
                    <li>所有收益率均针对满效率（即生产速度大于每秒材料消耗）且将售出时间设置为与制作时间近似相同的情况</li>
                    <li>产能收益公式为：(基础价格 / 生产时间) * sqrt(生产时间 / 100)</li>
                    <li>若效率未满收益率需乘以一系数(仍需要售出时间≈制作一个产品所需时间，不过此处制作时间需根据材料生产速度自行计算)，系数值为sqrt(生产速度/满效率材料消耗速度)，对需要多材料的，此系数取各材料计算系数的最小值</li>
                </ol>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ===================================================================
            // SCRIPT FOR: 工匠收益计算器 (Artisan Profit Calculator)
            // ===================================================================
            (function () {
                // All artisan calculator code is placed here...
                const MAX_DISPLAY_LEVEL = 5;
                const initialProductsData = [
                    { name: "绳子", productionTimeStr: "1m", materials: "纤维100k", basePrice: 10, isUnlocked: true, level: 1, upgrade1_desc: "解锁袋子", upgrade1_req: 100, upgrade2_desc: "时间->40s", upgrade2_req: 750, upgrade3_desc: "价格->14", upgrade3_req: 4800, upgrade4_desc: "时间->30s", upgrade4_req: 27000 },
                    { name: "木板", productionTimeStr: "2m", materials: "木头250k", basePrice: 22, isUnlocked: true, level: 1, upgrade1_desc: "时间->1m30s", upgrade1_req: 60, upgrade2_desc: "解锁橱柜", upgrade2_req: 450, upgrade3_desc: "价格->30", upgrade3_req: 3200, upgrade4_desc: "时间->1m15s", upgrade4_req: 16500 },
                    { name: "砖块", productionTimeStr: "4m", materials: "石头600k", basePrice: 48, isUnlocked: true, level: 1, upgrade1_desc: "价格->66", upgrade1_req: 40, upgrade2_desc: "时间->3m", upgrade2_req: 300, upgrade3_desc: "解锁哑铃", upgrade3_req: 2000, upgrade4_desc: "价格->84", upgrade4_req: 12000 },
                    { name: "螺丝", productionTimeStr: "2m", materials: "金属800k", basePrice: 25, isUnlocked: true, level: 1, upgrade1_desc: "价格->34", upgrade1_req: 100, upgrade2_desc: "时间->1m40s", upgrade2_req: 550, upgrade3_desc: "解锁剪刀", upgrade3_req: 4400, upgrade4_desc: "价格->44", upgrade4_req: 21000 },
                    { name: "水瓶", productionTimeStr: "1m10s", materials: "水1.5m", basePrice: 15, isUnlocked: true, level: 1, upgrade1_desc: "时间->50s", upgrade1_req: 300, upgrade2_desc: "时间->35s", upgrade2_req: 1700, upgrade3_desc: "解锁草药茶", upgrade3_req: 9250, upgrade4_desc: "时间->25s", upgrade4_req: 53000 },
                    { name: "鸡尾酒杯", productionTimeStr: "3m30s", materials: "玻璃2.5m", basePrice: 50, isUnlocked: true, level: 1, upgrade1_desc: "价格->67", upgrade1_req: 45, upgrade2_desc: "时间->3m", upgrade2_req: 360, upgrade3_desc: "解锁玻璃杯", upgrade3_req: 2500, upgrade4_desc: "价格->86", upgrade4_req: 14500 },
                    { name: "回力标", productionTimeStr: "2m20s", materials: "硬木4m", basePrice: 38, isUnlocked: true, level: 1, upgrade1_desc: "价格->51", upgrade1_req: 45, upgrade2_desc: "时间->2m", upgrade2_req: 360, upgrade3_desc: "价格->65", upgrade3_req: 14500, upgrade4_desc: "", upgrade4_req: null },
                    { name: "抛光宝石", productionTimeStr: "2m40s", materials: "宝石6.5m", basePrice: 36, isUnlocked: true, level: 1, upgrade1_desc: "价格->47", upgrade1_req: 55, upgrade2_desc: "时间->2m20s", upgrade2_req: 380, upgrade3_desc: "价格->60", upgrade3_req: 13500, upgrade4_desc: "", upgrade4_req: null },
                    { name: "油灯", productionTimeStr: "4m30s", materials: "油10m", basePrice: 51, isUnlocked: true, level: 1, upgrade1_desc: "价格->65", upgrade1_req: 40, upgrade2_desc: "时间->3m45s", upgrade2_req: 330, upgrade3_desc: "价格->82", upgrade3_req: 12400, upgrade4_desc: "", upgrade4_req: null },
                    { name: "淋浴", productionTimeStr: "6m", materials: "大理石15m", basePrice: 70, isUnlocked: true, level: 1, upgrade1_desc: "时间->5m", upgrade1_req: 40, upgrade2_desc: "价格->90", upgrade2_req: 330, upgrade3_desc: "时间->4m10s", upgrade3_req: 12400, upgrade4_desc: "", upgrade4_req: null },
                    { name: "袋子", productionTimeStr: "1m30s", materials: "纤维1m", basePrice: 18, isUnlocked: true, level: 1, upgrade1_desc: "价格->26", upgrade1_req: 80, upgrade2_desc: "时间->70s", upgrade2_req: 600, upgrade3_desc: "价格->35", upgrade3_req: 4000, upgrade4_desc: "时间->60s", upgrade4_req: 22000 },
                    { name: "橱柜", productionTimeStr: "2m30s", materials: "木头3m", basePrice: 33, isUnlocked: true, level: 1, upgrade1_desc: "价格->42", upgrade1_req: 50, upgrade2_desc: "时间->2m5s", upgrade2_req: 400, upgrade3_desc: "价格->52", upgrade3_req: 2800, upgrade4_desc: "时间->1m40s", upgrade4_req: 15000 },
                    { name: "哑铃", productionTimeStr: "5m", materials: "石头7m", basePrice: 65, isUnlocked: true, level: 1, upgrade1_desc: "价格->87", upgrade1_req: 50, upgrade2_desc: "时间->4m15s", upgrade2_req: 400, upgrade3_desc: "解锁手锯★", upgrade3_req: 2800, upgrade4_desc: "时间->3m30s", upgrade4_req: 15000 },
                    { name: "剪刀", productionTimeStr: "2m5s", materials: "木头3m+金属8m", basePrice: 30, isUnlocked: true, level: 1, upgrade1_desc: "时间->1m50s", upgrade1_req: 55, upgrade2_desc: "价格->40", upgrade2_req: 420, upgrade3_desc: "时间->1m40s", upgrade3_req: 3100, upgrade4_desc: "价格->50", upgrade4_req: 17000 },
                    { name: "草药茶", productionTimeStr: "3m20s", materials: "纤维5m+水12m", basePrice: 54, isUnlocked: true, level: 1, upgrade1_desc: "价格->78", upgrade1_req: 48, upgrade2_desc: "价格->106", upgrade2_req: 380, upgrade3_desc: "时间->2m50s", upgrade3_req: 2600, upgrade4_desc: "价格->140", upgrade4_req: 14000 },
                    { name: "玻璃杯", productionTimeStr: "1m20s", materials: "金属11m+玻璃14m", basePrice: 21, isUnlocked: true, level: 1, upgrade1_desc: "时间->1m5s", upgrade1_req: 100, upgrade2_desc: "价格->28", upgrade2_req: 750, upgrade3_desc: "时间->55s", upgrade3_req: 5400, upgrade4_desc: "时间->45s", upgrade4_req: 30000 },
                    { name: "箭头", productionTimeStr: "1m40s", materials: "木头1.25m+石头400k", basePrice: 21, isUnlocked: true, level: 1, upgrade1_desc: "时间->1m25s", upgrade1_req: 85, upgrade2_desc: "时间->1m10s", upgrade2_req: 400, upgrade3_desc: "时间->1m", upgrade3_req: 10000, upgrade4_desc: "", upgrade4_req: null },
                    { name: "碗", productionTimeStr: "2m10s", materials: "木头2.5m", basePrice: 25, isUnlocked: true, level: 1, upgrade1_desc: "时间->1m40s", upgrade1_req: 90, upgrade2_desc: "解锁灌木★", upgrade2_req: 675, upgrade3_desc: "价格->34", upgrade3_req: 4800, upgrade4_desc: "时间->1m20s", upgrade4_req: 25000 },
                    { name: "锁链", productionTimeStr: "1m10s", materials: "纤维3m+金属1.35m", basePrice: 19, isUnlocked: true, level: 1, upgrade1_desc: "时间->1m", upgrade1_req: 140, upgrade2_desc: "解锁车库★", upgrade2_req: 875, upgrade3_desc: "价格->25", upgrade3_req: 4300, upgrade4_desc: "时间->50s", upgrade4_req: 23000 },
                    { name: "矛", productionTimeStr: "2m", materials: "木头8m+金属1.75m", basePrice: 26, isUnlocked: true, level: 1, upgrade1_desc: "时间->1m35s", upgrade1_req: 110, upgrade2_desc: "价格->35", upgrade2_req: 800, upgrade3_desc: "时间->1m15s", upgrade3_req: 5750, upgrade4_desc: "价格->45", upgrade4_req: 28000 },
                    { name: "金戒指", productionTimeStr: "10m", materials: "金属5m+水750k", basePrice: 140, isUnlocked: true, level: 1, upgrade1_desc: "价格->188", upgrade1_req: 30, upgrade2_desc: "价格->239", upgrade2_req: 225, upgrade3_desc: "价格->295", upgrade3_req: 1800, upgrade4_desc: "", upgrade4_req: null }
                ];

                const toggleAllLockCheckbox = document.getElementById('toggleAllLockCheckbox');
                let products = initialProductsData.map(p => ({ ...p, id: p.name.replace(/\s+/g, '-'), originalProductionTimeSeconds: parseProductionTime(p.productionTimeStr), originalBasePrice: p.basePrice }));
                let sortAscending = false;
                let profitChart = null;
                const tableBody = document.getElementById('productTable').getElementsByTagName('tbody')[0];
                const sortHeaderRate = document.getElementById('sortHeaderRate');
                const craftsmenInput = document.getElementById('craftsmenInput');
                const countersInput = document.getElementById('countersInput');
                const calculateKValuesBtn = document.getElementById('calculateKValuesBtn');
                const maxProfitResultDiv = document.getElementById('maxProfitResult');
                const kDistributionResultDiv = document.getElementById('kDistributionResult');
                const LOCAL_STORAGE_KEY_ARTISAN = 'craftingCalculatorProductStates';

                function saveStateToLocalStorage() { /* ... */ const stateToSave = products.map(p => ({ name: p.name, level: p.level, isUnlocked: p.isUnlocked })); localStorage.setItem(LOCAL_STORAGE_KEY_ARTISAN, JSON.stringify(stateToSave)); }
                function loadStateFromLocalStorage() { /* ... */ const savedState = localStorage.getItem(LOCAL_STORAGE_KEY_ARTISAN); if (savedState) { try { const loadedStates = JSON.parse(savedState); loadedStates.forEach(loadedState => { const product = products.find(p => p.name === loadedState.name); if (product) { product.level = loadedState.level !== undefined ? loadedState.level : product.level; product.isUnlocked = loadedState.isUnlocked !== undefined ? loadedState.isUnlocked : product.isUnlocked; } }); } catch (e) { console.error("Error loading state:", e); localStorage.removeItem(LOCAL_STORAGE_KEY_ARTISAN); } } }
                function parseProductionTime(timeStr) { /* ... */ if (!timeStr) return 0; let totalSeconds = 0; const minutesMatch = timeStr.match(/(\d+)m/); const secondsMatch = timeStr.match(/(\d+)s/); if (minutesMatch) totalSeconds += parseInt(minutesMatch[1]) * 60; if (secondsMatch) totalSeconds += parseInt(secondsMatch[1]); return totalSeconds; }
                function formatTime(totalSeconds) { /* ... */ if (totalSeconds <= 0) return "0s"; const minutes = Math.floor(totalSeconds / 60); const seconds = Math.round(totalSeconds % 60); let timeStr = ""; if (minutes > 0) timeStr += `${minutes}m`; if (seconds > 0 || minutes === 0) timeStr += `${seconds}s`; return timeStr || "0s"; }
                function parseMaterials(materialsStr) { /* ... */ if (!materialsStr) return []; const materials = []; const parts = materialsStr.split('+'); parts.forEach(part => { const match = part.trim().match(/([^\d]+)(\d+\.?\d*)([km]?)/i); if (match) { const name = match[1].trim(); let amount = parseFloat(match[2]); const unit = match[3] ? match[3].toLowerCase() : ''; if (unit === 'k') amount *= 1000; else if (unit === 'm') amount *= 1000000; materials.push({ name, amount }); } }); return materials; }
                function toggleProductLock(productName) { /* ... */ const product = products.find(p => p.name === productName); if (product) { product.isUnlocked = !product.isUnlocked; saveStateToLocalStorage(); updateToggleAllCheckboxState(); updateAndSortProducts(true, sortAscending); } }
                function updateToggleAllCheckboxState() { /* ... */ if (!products || products.length === 0) { toggleAllLockCheckbox.checked = false; toggleAllLockCheckbox.indeterminate = false; return; } const allUnlocked = products.every(p => p.isUnlocked); const noneUnlocked = products.every(p => !p.isUnlocked); if (allUnlocked) { toggleAllLockCheckbox.checked = true; toggleAllLockCheckbox.indeterminate = false; } else if (noneUnlocked) { toggleAllLockCheckbox.checked = false; toggleAllLockCheckbox.indeterminate = false; } else { toggleAllLockCheckbox.checked = false; toggleAllLockCheckbox.indeterminate = true; } }
                function calculateMaterialConsumptionPerSecond(materialsArray, productionTimeSeconds) { /* ... */ if (productionTimeSeconds <= 0 || !materialsArray || materialsArray.length === 0) return "-"; return materialsArray.map(mat => { const consumption = mat.amount / productionTimeSeconds; let displayConsumption = consumption.toFixed(1); if (consumption >= 1000000) displayConsumption = (consumption / 1000000).toFixed(1) + "m"; else if (consumption >= 1000) displayConsumption = (consumption / 1000).toFixed(1) + "k"; return `${mat.name} ${displayConsumption}/s`; }).join('; '); }
                function calculateProfitRate(basePrice, productionTimeSeconds) { /* ... */ if (productionTimeSeconds <= 0 || basePrice <= 0) return 0; const rate = (basePrice / productionTimeSeconds) * Math.sqrt(productionTimeSeconds / 100) * 60; return parseFloat(rate.toFixed(4)); }
                function getUpgradeInfoAsTextForTitle(product) { /* ... */ if (!product) return "无升级信息"; let infoText = `产品: ${product.name} (当前等级: ${product.level})\n后续升级路径:\n`; let hasAnyDefinedUpgrades = false; let tempTime = product.currentProductionTimeSeconds; let tempPrice = product.currentBasePrice; for (let i = product.level; i < MAX_DISPLAY_LEVEL; i++) { const upgradeDesc = product[`upgrade${i}_desc`]; const upgradeReq = product[`upgrade${i}_req`]; if (upgradeDesc && upgradeDesc.trim() !== "") { hasAnyDefinedUpgrades = true; infoText += `  升至 ${i + 1} 级: ${upgradeDesc} (需: ${upgradeReq != null ? upgradeReq : "-"})`; let timeAfterThisUpgrade = tempTime, priceAfterThisUpgrade = tempPrice; const parts = upgradeDesc.split('->'); if (parts.length === 2) { const type = parts[0].trim(), valueStr = parts[1].trim(); if (type === "时间") timeAfterThisUpgrade = parseProductionTime(valueStr); else if (type === "价格") priceAfterThisUpgrade = parseFloat(valueStr); } if (timeAfterThisUpgrade !== tempTime) { infoText += ` => 时间变为: ${formatTime(timeAfterThisUpgrade)}`; tempTime = timeAfterThisUpgrade; } if (priceAfterThisUpgrade !== tempPrice) { infoText += `${(timeAfterThisUpgrade !== tempTime && priceAfterThisUpgrade !== tempPrice) ? ', ' : ' => '}价格变为: ${priceAfterThisUpgrade.toFixed(2)}`; tempPrice = priceAfterThisUpgrade; } infoText += "\n"; } } if (!hasAnyDefinedUpgrades && product.level < MAX_DISPLAY_LEVEL) infoText += "  无更多已定义的数值升级。\n"; else if (product.level >= MAX_DISPLAY_LEVEL) infoText += "  已达最高显示等级。\n"; return infoText.trim(); }
                function calculateProductStateForLevel(product, level) { /* ... */ let currentProductionTimeSeconds = product.originalProductionTimeSeconds; let currentBasePrice = product.originalBasePrice; for (let i = 1; i < level; i++) { const upgradeDesc = product[`upgrade${i}_desc`]; if (upgradeDesc && upgradeDesc.includes("->")) { const parts = upgradeDesc.split('->'), type = parts[0].trim(), valueStr = parts[1].trim(); if (type === "时间") currentProductionTimeSeconds = parseProductionTime(valueStr); else if (type === "价格") currentBasePrice = parseFloat(valueStr); } } const currentProfitRate = calculateProfitRate(currentBasePrice, currentProductionTimeSeconds); const materialConsumptionStr = calculateMaterialConsumptionPerSecond(parseMaterials(product.materials), currentProductionTimeSeconds); product.currentProductionTimeSeconds = currentProductionTimeSeconds; product.currentBasePrice = currentBasePrice; const upgradeInfoText = getUpgradeInfoAsTextForTitle(product); let nextLevelPreview = { timeStr: null, price: null, profitRate: null, materialConsumption: null }, hasAnyPreview = false; if (level < MAX_DISPLAY_LEVEL) { let nextProdTimeSecCandidate = currentProductionTimeSeconds, nextBasePriceCandidate = currentBasePrice; const nextUpgradeDesc = product[`upgrade${level}_desc`]; if (nextUpgradeDesc && nextUpgradeDesc.includes("->")) { const parts = nextUpgradeDesc.split('->'), type = parts[0].trim(), valueStr = parts[1].trim(); if (type === "时间") nextProdTimeSecCandidate = parseProductionTime(valueStr); else if (type === "价格") nextBasePriceCandidate = parseFloat(valueStr); } if (nextProdTimeSecCandidate !== currentProductionTimeSeconds) { nextLevelPreview.timeStr = formatTime(nextProdTimeSecCandidate); hasAnyPreview = true; } if (nextBasePriceCandidate !== currentBasePrice) { nextLevelPreview.price = parseFloat(nextBasePriceCandidate.toFixed(2)); hasAnyPreview = true; } if (hasAnyPreview) { const timeForNextCalc = nextLevelPreview.timeStr ? nextProdTimeSecCandidate : currentProductionTimeSeconds, priceForNextCalc = nextLevelPreview.price !== null ? nextBasePriceCandidate : currentBasePrice; const nextProfit = calculateProfitRate(priceForNextCalc, timeForNextCalc), nextMatCons = calculateMaterialConsumptionPerSecond(parseMaterials(product.materials), timeForNextCalc); if (nextProfit.toFixed(4) !== currentProfitRate.toFixed(4)) nextLevelPreview.profitRate = parseFloat(nextProfit.toFixed(4)); if (nextMatCons !== materialConsumptionStr) nextLevelPreview.materialConsumption = nextMatCons; } } return { currentProductionTimeSeconds: parseFloat(currentProductionTimeSeconds.toFixed(2)), currentProductionTimeStr: formatTime(currentProductionTimeSeconds), currentBasePrice: parseFloat(currentBasePrice.toFixed(2)), profitRate: currentProfitRate, materialConsumption: materialConsumptionStr, nextLevelPreview: hasAnyPreview ? nextLevelPreview : null, upgradeInfoText: upgradeInfoText }; }

                function renderTable() {
                    tableBody.innerHTML = '';
                    products.forEach((product) => {
                        const row = tableBody.insertRow();
                        row.dataset.productName = product.name;
                        if (!product.isUnlocked) {
                            row.style.opacity = "0.5";
                            row.style.fontStyle = "italic";
                        }
                        const cellUnlock = row.insertCell();
                        const unlockCheckbox = document.createElement('input');
                        unlockCheckbox.type = 'checkbox';
                        unlockCheckbox.checked = product.isUnlocked;
                        unlockCheckbox.title = product.isUnlocked ? "标记为未解锁" : "标记为已解锁";
                        unlockCheckbox.onchange = () => toggleProductLock(product.name);
                        cellUnlock.appendChild(unlockCheckbox);
                        row.insertCell().textContent = product.name;
                        const cellTime = row.insertCell();
                        cellTime.innerHTML = product.currentProductionTimeStr + (product.nextLevelPreview && product.nextLevelPreview.timeStr !== null ? ` <span class="preview-text">(→ ${product.nextLevelPreview.timeStr})</span>` : '');
                        const cellPrice = row.insertCell();
                        cellPrice.innerHTML = product.currentBasePrice.toFixed(2) + (product.nextLevelPreview && product.nextLevelPreview.price !== null ? ` <span class="preview-text">(→ ${product.nextLevelPreview.price.toFixed(2)})</span>` : '');
                        const cellLevel = row.insertCell();
                        cellLevel.classList.add('level-control');
                        const btnMinus = document.createElement('button');
                        btnMinus.textContent = '-';
                        btnMinus.disabled = product.level <= 1 || !product.isUnlocked;
                        btnMinus.onclick = () => adjustLevel(product.name, -1);
                        const spanLevel = document.createElement('span');
                        spanLevel.classList.add('level-value');
                        spanLevel.textContent = product.level;
                        const btnPlus = document.createElement('button');
                        btnPlus.textContent = '+';
                        btnPlus.disabled = product.level >= MAX_DISPLAY_LEVEL || !product.isUnlocked;
                        btnPlus.onclick = () => adjustLevel(product.name, 1);
                        btnPlus.title = product.isUnlocked ? product.upgradeInfoText : "产品未解锁";
                        cellLevel.appendChild(btnMinus);
                        cellLevel.appendChild(spanLevel);
                        cellLevel.appendChild(btnPlus);
                        const cellProfitRate = row.insertCell();
                        cellProfitRate.innerHTML = product.profitRate.toFixed(4) + (product.nextLevelPreview && product.nextLevelPreview.profitRate !== null ? ` <span class="preview-text">(→ ${product.nextLevelPreview.profitRate.toFixed(4)})</span>` : '');
                        const cellMaterialConsumption = row.insertCell();
                        cellMaterialConsumption.classList.add('material-consumption');
                        cellMaterialConsumption.innerHTML = (product.materialConsumption || "-").replace(/<br>/g, '; ') + (product.nextLevelPreview && product.nextLevelPreview.materialConsumption !== null ? `<br><span class="preview-text">(→ ${product.nextLevelPreview.materialConsumption.replace(/<br>/g, '; ')})</span>` : '');
                        if (!product.isUnlocked) {
                            cellLevel.querySelectorAll('button').forEach(btn => btn.disabled = true);
                            if (spanLevel) spanLevel.style.opacity = 0.6;
                        }
                    });

                    // --- 新增代码开始 ---
                    const levelHeader = document.getElementById('levelHeader');
                    if (levelHeader) {
                        // 公式：每个产品的等级-1，然后求和
                        const totalLevel = products.reduce((total, p) => total + (p.level - 1), 0);
                        levelHeader.textContent = `等级 (${totalLevel})`;
                    }
                    // --- 新增代码结束 ---

                    updateChart();
                    updateToggleAllCheckboxState();
                }
                function adjustLevel(productName, change) { /* ... */ const product = products.find(p => p.name === productName); if (!product || !product.isUnlocked) return; let newLevel = product.level + change; if (newLevel < 1) newLevel = 1; if (newLevel > MAX_DISPLAY_LEVEL) newLevel = MAX_DISPLAY_LEVEL; if (product.level !== newLevel) { product.level = newLevel; saveStateToLocalStorage(); updateAndSortProducts(); } }
                function updateAndSortProducts(sortByProfit = true, sortDirectionAsc = undefined) { /* ... */ if (sortDirectionAsc !== undefined) sortAscending = sortDirectionAsc; products.forEach(product => { Object.assign(product, calculateProductStateForLevel(product, product.level)); }); const unlockedProducts = products.filter(p => p.isUnlocked); const lockedProducts = products.filter(p => !p.isUnlocked); if (sortByProfit && unlockedProducts.length > 0) unlockedProducts.sort((a, b) => sortAscending ? a.profitRate - b.profitRate : b.profitRate - a.profitRate); products = [...unlockedProducts, ...lockedProducts]; renderTable(); }
                function updateChart() { /* ... */ const unlockedProductsForChart = products.filter(p => p.isUnlocked); const chartLabels = unlockedProductsForChart.map(p => p.name); const chartData = unlockedProductsForChart.map(p => p.profitRate); if (profitChart) { profitChart.data.labels = chartLabels; profitChart.data.datasets[0].data = chartData; profitChart.update(); } else { const ctx = document.getElementById('profitRateChart').getContext('2d'); profitChart = new Chart(ctx, { type: 'bar', data: { labels: chartLabels, datasets: [{ label: '每分钟收益率 (仅已解锁)', data: chartData, backgroundColor: 'rgba(75, 192, 192, 0.6)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, animation: { duration: 300 } } }); } }
                function calculateKValuesAndMaxProfit() { /* ... */ const m = parseInt(craftsmenInput.value); const n_counters = parseInt(countersInput.value); const sortedUnlockedProducts = [...products.filter(p => p.isUnlocked)].sort((a, b) => b.profitRate - a.profitRate); const topNProducts = sortedUnlockedProducts.slice(0, n_counters); if (topNProducts.length === 0) { maxProfitResultDiv.textContent = "无已解锁产品可供计算。"; kDistributionResultDiv.textContent = ""; return; } const C_values = topNProducts.map(p => p.profitRate); let sum_C_squared = C_values.reduce((acc, c) => acc + c * c, 0); if (sum_C_squared === 0) { maxProfitResultDiv.textContent = `最大收益 = 0`; kDistributionResultDiv.innerHTML = "k值分配: 分母为0，无法计算。"; return; } const max_profit_val = Math.sqrt(sum_C_squared) * Math.sqrt(m); maxProfitResultDiv.textContent = `理论最大收益 = ${max_profit_val.toFixed(4)}/min`; let kDistributionHtml = "时间分配:<br>"; topNProducts.forEach(product => { kDistributionHtml += `${product.name}: k = ${((product.profitRate * product.profitRate) / sum_C_squared).toFixed(4)} (${product.profitRate.toFixed(4)}/min)<br>`; }); kDistributionResultDiv.innerHTML = kDistributionHtml; const lazySchemeProfitResultDiv = document.getElementById('lazySchemeProfitResult'); const improvementRateResultDiv = document.getElementById('improvementRateResult'); if (m > 0 && sortedUnlockedProducts.length > 0) { const topMProductsForLazy = sortedUnlockedProducts.slice(0, m); let lazySchemeTotalProfitRate = topMProductsForLazy.reduce((sum, p) => sum + p.profitRate, 0); let lazySchemeDetails = topMProductsForLazy.map(p => ` - ${p.name}: ${p.profitRate.toFixed(4)}/min`).join('<br>'); lazySchemeProfitResultDiv.innerHTML = `<b>总计收益: ${lazySchemeTotalProfitRate.toFixed(4)}/min</b><br/>${lazySchemeDetails}`; if (lazySchemeTotalProfitRate > 0) { const improvement = ((max_profit_val - lazySchemeTotalProfitRate) / lazySchemeTotalProfitRate) * 100; improvementRateResultDiv.textContent = `最优方案相比偷懒方案的效率提升约: ${improvement.toFixed(2)}%`; } else if (max_profit_val > 0) { improvementRateResultDiv.textContent = "偷懒方案收益为0，无法计算提升率。"; } else { improvementRateResultDiv.textContent = "两种方案收益均为0。"; } } else { lazySchemeProfitResultDiv.textContent = "无法计算偷懒方案。"; improvementRateResultDiv.textContent = ""; } }

                loadStateFromLocalStorage();
                updateAndSortProducts(true, false);
                sortHeaderRate.addEventListener('click', () => { sortAscending = !sortAscending; sortHeaderRate.querySelector('span').textContent = sortAscending ? '▲' : '▼'; updateAndSortProducts(true, sortAscending); });
                toggleAllLockCheckbox.addEventListener('change', function () { products.forEach(p => { p.isUnlocked = this.checked; }); saveStateToLocalStorage(); updateAndSortProducts(true, sortAscending); });
                calculateKValuesBtn.addEventListener('click', calculateKValuesAndMaxProfit);
                calculateKValuesAndMaxProfit();
            })();
        });
    </script>
</body>

</html>